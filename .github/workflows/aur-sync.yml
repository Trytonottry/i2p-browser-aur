name: Sync to AUR

on:
  push:
    branches:
      - main

jobs:
  sync:
    name: Sync GitHub → AUR
    runs-on: ubuntu-latest

    steps:
      # --- Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Запоминаем старый pkgver (до синка)
      - name: Read previous pkgver
        id: oldver
        run: |
          if [ -f PKGBUILD ]; then
            source PKGBUILD
            echo "version=$pkgver" >> $GITHUB_OUTPUT
          else
            echo "version=0" >> $GITHUB_OUTPUT
          fi

      # --- Генерация .SRCINFO через официальный Arch Linux контейнер
      - name: Generate .SRCINFO in Arch container
        run: |
          docker run --rm -v "$PWD":/build -w /build archlinux bash -c "
            pacman -Sy --noconfirm pacman-contrib base-devel &&
            makepkg --printsrcinfo > .SRCINFO
          "

      # --- Читаем новый pkgver
      - name: Read new pkgver
        id: newver
        run: |
          source PKGBUILD
          echo "version=$pkgver" >> $GITHUB_OUTPUT

      # --- Добавление SSH ключа для AUR
      - name: Add AUR SSH key
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          printf "Host aur.archlinux.org\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

      # --- Git identity
      - name: Git identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      # --- remote AUR
      - name: Add AUR remote
        run: |
          git remote remove aur 2>/dev/null || true
          git remote add aur ssh://aur@aur.archlinux.org/i2p-browser.git

      # --- Commit + push в AUR
      - name: Push to AUR
        run: |
          git add PKGBUILD .SRCINFO
          git commit -m "Auto sync from GitHub" || true
          git push aur HEAD:master || true

      # --- Если версия изменилась — создаём тег
      - name: Create GitHub Tag
        if: ${{ steps.oldver.outputs.version != steps.newver.outputs.version }}
        run: |
          TAG="v${{ steps.newver.outputs.version }}"
          git tag "$TAG"
          git push origin "$TAG"




